<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>[ADMIN] 신촌 꾼 낚시카페 랭킹보드</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-main: radial-gradient(circle at top left, #0f172a 0, #020617 45%, #000 100%);
      --card-bg: rgba(15,23,42,0.96);
      --card-border: rgba(148,163,184,0.35);
      --blue: #38bdf8;
      --blue-soft: rgba(56,189,248,0.16);
      --text-main: #e5e7eb;
      --text-muted: #64748b;
      --radius-lg: 18px;
      --shadow-soft: 0 22px 45px rgba(15,23,42,0.9);
    }
    * { box-sizing:border-box; }
    html,body {
      margin:0;
      padding:0;
      min-height:100%;
      background:#020617;
      background-image:var(--bg-main);
      color:var(--text-main);
      font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    body {
      display:flex;
      justify-content:center;
      padding:28px 16px 40px;
    }
    .wrap {
      width:100%;
      max-width:1280px;
    }
    header {
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:16px;
    }
    .logo {
      width:50px;
      height:50px;
      border-radius:999px;
      background:radial-gradient(circle at 20% 20%, #facc15, #0ea5e9 45%, #0f172a 80%);
      box-shadow:0 0 18px rgba(56,189,248,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:26px;
      color:#0b1120;
    }
    .title-area h1 {
      margin:0;
      font-size:22px;
      font-weight:700;
    }
    .title-area p {
      margin:2px 0 0;
      font-size:13px;
      color:var(--text-muted);
    }
    .status {
      margin-left:auto;
      text-align:right;
      font-size:11px;
      color:var(--text-muted);
    }
    .status span.badge {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.8);
      border:1px solid rgba(56,189,248,0.4);
      font-size:11px;
      margin-bottom:4px;
    }
    .status-dot {
      width:6px;
      height:6px;
      border-radius:999px;
      background:#4ade80;
      box-shadow:0 0 6px #22c55e;
    }

    .card {
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      border:1px solid var(--card-border);
      box-shadow:var(--shadow-soft);
      padding:14px 16px 16px;
      margin-bottom:16px;
      position:relative;
      overflow:hidden;
    }
    .card::before {
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at top, rgba(56,189,248,0.12), transparent 55%);
      opacity:0.4;
      pointer-events:none;
    }
    .card-inner { position:relative; z-index:1; }
    .card-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .card-title {
      font-size:16px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .pill {
      display:inline-flex;
      align-items:center;
      padding:1px 7px;
      border-radius:999px;
      background:var(--blue-soft);
      border:1px solid rgba(56,189,248,0.5);
      color:var(--blue);
      font-size:11px;
      font-weight:600;
    }
    .desc {
      font-size:12px;
      color:var(--text-muted);
      margin-bottom:6px;
    }
    .grid {
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:16px;
    }
    @media (max-width:960px) {
      .grid { grid-template-columns:repeat(1,minmax(0,1fr)); }
    }

    table { width:100%; border-collapse:separate; border-spacing:0 6px; font-size:13px; }
    th,td { padding:6px 6px; }
    thead th { font-size:11px; color:var(--text-muted); text-align:left; }
    tbody tr { background:rgba(15,23,42,0.9); border-radius:12px; }
    tbody td:first-child { border-top-left-radius:12px; border-bottom-left-radius:12px; }
    tbody td:last-child { border-top-right-radius:12px; border-bottom-right-radius:12px; }
    tbody td { border-top:1px solid rgba(15,23,42,0.9); border-bottom:1px solid rgba(15,23,42,0.9); }
    tbody td.num { width:32px; font-size:12px; color:var(--text-muted); text-align:right; padding-right:6px; }

    input[type="text"], input[type="password"] {
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.9);
      color:var(--text-main);
      font-size:13px;
    }
    input[type="text"]:focus, input[type="password"]:focus {
      outline:none;
      border-color:var(--blue);
      box-shadow:0 0 0 1px rgba(56,189,248,0.5);
    }

    .btn {
      border-radius:12px;
      border:none;
      background:linear-gradient(to right,#0ea5e9,#6366f1);
      color:white;
      padding:8px 14px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn.sub {
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.7);
      color:var(--text-main);
    }
    .btn.small { padding:6px 10px; font-size:12px; }

    .top-bar {
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
      font-size:12px;
      color:var(--text-muted);
    }
    .top-bar .spacer { flex:1; }
    .tag { font-size:11px; color:var(--text-muted); }

    /* gate */
    #gate { margin-bottom:16px; }
    #panel { display:none; }
    .gate-row { display:flex; gap:8px; margin-bottom:8px; }
    .gate-row .grow { flex:1; }

    .bingo-grid {
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
    }
    .bingo-cell {
      background:rgba(15,23,42,0.95);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.6);
      padding:8px;
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .bingo-row { display:flex; gap:6px; }
    .bingo-row input { flex:1; }
    .bingo-toggle {
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      color:var(--text-main);
      font-size:11px;
      padding:5px 6px;
      cursor:pointer;
    }
    .bingo-cell.used { opacity:0.55; }

    .badge-input-row { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px; }
    select {
      padding:7px 9px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.9);
      color:var(--text-main);
      font-size:13px;
    }
    .badge-list { display:flex; flex-wrap:wrap; gap:6px; font-size:12px; }
    .badge-pill {
      border-radius:999px;
      border:1px solid rgba(56,189,248,0.5);
      background:rgba(15,23,42,0.9);
      padding:2px 8px;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .badge-pill .x {
      cursor:pointer;
      font-size:11px;
      color:#fca5a5;
    }

    .footer-bar {
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:6px;
      font-size:11px;
      color:var(--text-muted);
    }
    .footer-bar .spacer { flex:1; }

    @media (max-width:640px) {
      body { padding:18px 10px 30px; }
      header { flex-direction:column; align-items:flex-start; gap:8px; }
      .status { margin-left:0; text-align:left; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">⚙</div>
      <div class="title-area">
        <h1>[ADMIN] 신촌 꾼 낚시카페 랭킹보드</h1>
        <p>입력만 하면 손님용 랭킹보드(index.html)에 자동 반영됩니다.</p>
      </div>
      <div class="status">
        <span class="badge"><span class="status-dot"></span> Supabase 연동</span><br>
        <div>마지막 저장: <span id="lastSaved">-</span></div>
      </div>
    </header>

    <!-- 보안 게이트 -->
    <section class="card" id="gate">
      <div class="card-inner">
        <div class="card-header">
          <div class="card-title">관리자 잠금</div>
          <div class="pill">Alt + A 로 열기 / 닫기</div>
        </div>
        <div class="desc">최초 1회 비밀번호를 설정하면 이후부터는 해당 비밀번호로만 접속 가능합니다. (브라우저 LocalStorage에 SHA-256 해시로 저장)</div>

        <div id="gateSetup">
          <div class="gate-row">
            <div class="grow"><input type="password" id="newPw" placeholder="새 비밀번호" autocomplete="new-password"></div>
          </div>
          <div class="gate-row">
            <div class="grow"><input type="password" id="newPw2" placeholder="새 비밀번호 확인" autocomplete="new-password"></div>
          </div>
          <button class="btn" id="btnSetPw">비밀번호 설정</button>
        </div>

        <div id="gateLogin" style="display:none;">
          <div class="gate-row">
            <div class="grow"><input type="password" id="pw" placeholder="비밀번호" autocomplete="current-password"></div>
            <button class="btn" id="btnEnter">입장</button>
          </div>
          <div class="tag" id="gateMsg">비밀번호를 입력하세요.</div>
        </div>
      </div>
    </section>

    <div id="panel">
      <div class="top-bar">
        <span>※ 입력 후 맨 아래 <b>저장하기</b> 버튼을 꼭 눌러 주세요.</span>
        <div class="spacer"></div>
        <button class="btn sub small" id="btnChangePw">비밀번호 변경</button>
      </div>

      <section class="card" id="changePwCard" style="display:none;">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">비밀번호 변경</div>
          </div>
          <div class="gate-row">
            <div class="grow"><input type="password" id="curPw" placeholder="현재 비밀번호"></div>
          </div>
          <div class="gate-row">
            <div class="grow"><input type="password" id="npw1" placeholder="새 비밀번호"></div>
          </div>
          <div class="gate-row">
            <div class="grow"><input type="password" id="npw2" placeholder="새 비밀번호 확인"></div>
          </div>
          <button class="btn" id="btnApplyPw">변경 완료</button>
        </div>
      </section>

      <section class="grid">
        <section class="card">
          <div class="card-inner">
            <div class="card-header">
              <div class="card-title">대물왕</div>
              <div class="pill">Top 5</div>
            </div>
            <div class="desc">이름 / 점수를 입력하면 손님 화면에 <b>Top 5</b> 까지 자동 노출됩니다.</div>
            <table>
              <thead>
                <tr><th style="width:32px;">#</th><th>이름</th><th style="width:140px;">점수(숫자 우선)</th></tr>
              </thead>
              <tbody id="tbody_rank_big"></tbody>
            </table>
          </div>
        </section>

        <section class="card">
          <div class="card-inner">
            <div class="card-header">
              <div class="card-title">소물왕</div>
              <div class="pill">Top 5</div>
            </div>
            <div class="desc">귀여운 물고기, 이벤트용 기록 등.</div>
            <table>
              <thead>
                <tr><th style="width:32px;">#</th><th>이름</th><th style="width:140px;">점수(숫자 우선)</th></tr>
              </thead>
              <tbody id="tbody_rank_small"></tbody>
            </table>
          </div>
        </section>

        <section class="card">
          <div class="card-inner">
            <div class="card-header">
              <div class="card-title">천하제일 낚시대회</div>
              <div class="pill">Top 5</div>
            </div>
            <div class="desc">특별 대회 / 이벤트전 기록 입력.</div>
            <table>
              <thead>
                <tr><th style="width:32px;">#</th><th>이름</th><th style="width:140px;">점수(숫자 우선)</th></tr>
              </thead>
              <tbody id="tbody_rank_tour"></tbody>
            </table>
          </div>
        </section>

        <section class="card">
          <div class="card-inner">
            <div class="card-header">
              <div class="card-title">시즌전 전체 랭킹</div>
              <div class="pill">최대 100명</div>
            </div>
            <div class="desc">여기에 입력된 전체 리스트를 기준으로 손님 화면의 <b>Top 5</b> 및 <b>전체보기(100명)</b>이 계산됩니다.</div>
            <table>
              <thead>
                <tr><th style="width:32px;">#</th><th>이름</th><th style="width:140px;">점수(숫자 우선)</th></tr>
              </thead>
              <tbody id="tbody_rank_season"></tbody>
            </table>
          </div>
        </section>
      </section>

      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">치킨빙고 4 × 4</div>
          </div>
          <div class="desc">각 칸에 상품명을 적고, 사용된 칸은 아래 버튼으로 표시하면 손님 화면에서 자동으로 X 처리됩니다.</div>
          <div class="bingo-grid" id="bingoEditor"></div>
          <div class="footer-bar">
            <span>남은 칸: <b id="remainBingo">-</b></span>
            <div class="spacer"></div>
            <button class="btn sub small" id="btnResetBingo">빙고 전체 리셋</button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">시즌 뱃지 관리</div>
            <div class="pill" id="seasonId">-</div>
          </div>
          <div class="desc">시즌 동안 조건을 달성한 손님 이름을 자유롭게 추가 / 삭제할 수 있습니다. (손님 화면 하단에 노출)</div>

          <div class="badge-input-row">
            <select id="badgeCat">
              <option value="rank_big">대물왕</option>
              <option value="rank_small">소물왕</option>
              <option value="rank_tour">천하제일 대회</option>
              <option value="rank_season">시즌전</option>
            </select>
            <input type="text" id="badgeNames" placeholder="이름 여러 명은 쉼표로 구분 (예: 홍길동, 이순신, 마스터 킴)">
            <button class="btn small" id="btnBadgeAdd">추가</button>
          </div>
          <div class="tag" style="margin-bottom:6px;">· 중복은 자동 제거됩니다. · 이름 오른쪽 X 를 누르면 해당 이름만 삭제됩니다.</div>

          <div class="grid">
            <div>
              <div class="tag">대물왕</div>
              <div class="badge-list" data-badge="rank_big"></div>
            </div>
            <div>
              <div class="tag">소물왕</div>
              <div class="badge-list" data-badge="rank_small"></div>
            </div>
            <div>
              <div class="tag">천하제일 대회</div>
              <div class="badge-list" data-badge="rank_tour"></div>
            </div>
            <div>
              <div class="tag">시즌전</div>
              <div class="badge-list" data-badge="rank_season"></div>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">저장 / 초기화</div>
          </div>
          <div class="footer-bar">
            <button class="btn" id="btnSave">저장하기</button>
            <button class="btn sub" id="btnResetAll">전체 리셋 (랭킹 + 빙고만)</button>
            <div class="spacer"></div>
            <span>※ 저장 후 손님 화면(index.html)을 새로고침하면 바로 반영됩니다.</span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://vuadzeocolgypuapcvsz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1YWR6ZW9jb2xneXB1YXBjdnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMzE4MTksImV4cCI6MjA3ODYwNzgxOX0.Whi2uUQExqo8a5YF9lKCWhBcF6I29fdrrN-byDWZf2I";
    const TABLE_NAME = "kkun_state";
    const ROW_ID = "global";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ADMIN_HASH_KEY = "kkun_admin_hash_v2";
    const ATTEMPT_KEY = "kkun_admin_attempts_v2";

    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    function genSeasonId() {
      const d = new Date();
      const q = Math.floor(d.getMonth() / 3) + 1;
      return `${d.getFullYear()} Q${q}`;
    }

    function createDefaultState() {
      const bingo = Array.from({length:16}, () => ({ label:"", used:false }));
      return {
        lastUpdated: null,
        rank_big: [],
        rank_small: [],
        rank_tour: [],
        rank_season: [],
        bingo,
        season: {
          id: genSeasonId(),
          startedAt: new Date().toISOString(),
          badges: {
            rank_big: [],
            rank_small: [],
            rank_tour: [],
            rank_season: []
          }
        }
      };
    }

    function toNumber(v) {
      if (v === null || v === undefined) return 0;
      const n = parseFloat(String(v).replace(/[^0-9.-]/g, ""));
      return isNaN(n) ? 0 : n;
    }

    async function loadState() {
      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select("state")
        .eq("id", ROW_ID)
        .maybeSingle();
      if (error) {
        console.error("[admin] load error", error);
        return createDefaultState();
      }
      if (!data) {
        const init = createDefaultState();
        const { error: insertErr } = await supabase
          .from(TABLE_NAME)
          .insert({ id: ROW_ID, state: init });
        if (insertErr) console.error("[admin] insert error", insertErr);
        return init;
      }
      return data.state || createDefaultState();
    }

    async function saveState(state) {
      state.lastUpdated = new Date().toISOString();
      const payload = { id: ROW_ID, state };
      const { error } = await supabase
        .from(TABLE_NAME)
        .upsert([payload], { onConflict: "id" });
      if (error) {
        console.error("[admin] save error", error);
        alert("저장 중 오류가 발생했습니다. 콘솔을 확인해주세요.");
        return;
      }
      $("#lastSaved").textContent = new Date(state.lastUpdated).toLocaleString("ko-KR");
      alert("저장되었습니다. 손님 화면(index.html)을 새로고침해 보세요.");
    }

    // ===== 비밀번호 해시 =====
    async function sha256(text) {
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
    }

    function updateLastSaved(state) {
      const el = $("#lastSaved");
      if (!state.lastUpdated) { el.textContent = "-"; return; }
      try {
        el.textContent = new Date(state.lastUpdated).toLocaleString("ko-KR");
      } catch (e) {
        el.textContent = state.lastUpdated;
      }
    }

    // ===== 랭킹 입력 폼 구성 =====
    function buildRankTable(tbodyId, key, rows) {
      const tbody = document.getElementById(tbodyId);
      tbody.innerHTML = "";
      for (let i=0;i<rows;i++) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="num">${i+1}</td>
          <td><input type="text" data-rank="${key}" data-idx="${i}" data-field="name" placeholder="이름"></td>
          <td><input type="text" data-rank="${key}" data-idx="${i}" data-field="score" placeholder="예: 1234 (숫자 우선)"></td>
        `;
        tbody.appendChild(tr);
      }
    }

    function fillRankInputs(state) {
      const cfg = [
        ["rank_big","tbody_rank_big",5],
        ["rank_small","tbody_rank_small",5],
        ["rank_tour","tbody_rank_tour",5],
        ["rank_season","tbody_rank_season",100]
      ];
      cfg.forEach(([key,tbodyId,rows]) => {
        buildRankTable(tbodyId,key,rows);
        const list = state[key] || [];
        list.forEach((item, idx) => {
          if (idx >= rows) return;
          const nameInput = document.querySelector(`input[data-rank="${key}"][data-idx="${idx}"][data-field="name"]`);
          const scoreInput = document.querySelector(`input[data-rank="${key}"][data-idx="${idx}"][data-field="score"]`);
          if (nameInput) nameInput.value = item.name || "";
          if (scoreInput) scoreInput.value = item.score ?? "";
        });
      });
    }

    function collectRankState(state) {
      const keys = [
        ["rank_big",5],
        ["rank_small",5],
        ["rank_tour",5],
        ["rank_season",100]
      ];
      keys.forEach(([key,rows]) => {
        const list = [];
        for (let i=0;i<rows;i++) {
          const nameInput = document.querySelector(`input[data-rank="${key}"][data-idx="${i}"][data-field="name"]`);
          const scoreInput = document.querySelector(`input[data-rank="${key}"][data-idx="${i}"][data-field="score"]`);
          if (!nameInput || !scoreInput) continue;
          const name = nameInput.value.trim();
          const score = scoreInput.value.trim();
          if (!name && !score) continue;
          list.push({ name, score });
        }
        state[key] = list;
      });
    }

    // ===== 빙고 =====
    function renderBingoEditor(state) {
      const root = $("#bingoEditor");
      root.innerHTML = "";
      const cells = state.bingo || [];
      let remain = 0;
      cells.forEach((cell, idx) => {
        if (!cell) cell = { label:"", used:false };
        const div = document.createElement("div");
        div.className = "bingo-cell" + (cell.used ? " used" : "");
        const row1 = document.createElement("div");
        row1.className = "bingo-row";
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "상품명 예: 치킨 / 음료 / 1천P";
        input.value = cell.label || "";
        input.addEventListener("input", () => {
          state.bingo[idx].label = input.value;
        });
        row1.appendChild(input);
        const row2 = document.createElement("div");
        row2.className = "bingo-row";
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "bingo-toggle";
        const updateLabel = () => {
          btn.textContent = state.bingo[idx].used ? "사용됨 취소" : "사용됨 표시";
        };
        btn.addEventListener("click", () => {
          state.bingo[idx].used = !state.bingo[idx].used;
          renderBingoEditor(state);
        });
        updateLabel();
        row2.appendChild(btn);
        div.appendChild(row1);
        div.appendChild(row2);
        root.appendChild(div);
        if (!cell.used) remain++;
      });
      $("#remainBingo").textContent = remain;
    }

    function resetBingo(state) {
      if (!confirm("빙고 전체를 초기화할까요? (라벨 + 사용 상태 모두 삭제)")) return;
      state.bingo = Array.from({length:16}, () => ({ label:"", used:false }));
      renderBingoEditor(state);
    }

    // ===== 시즌 뱃지 =====
    function renderBadges(state) {
      const season = state.season || {
        id: genSeasonId(),
        badges: {
          rank_big: [],
          rank_small: [],
          rank_tour: [],
          rank_season: []
        }
      };
      $("#seasonId").textContent = season.id || "-";
      const badges = season.badges || {
        rank_big: [],
        rank_small: [],
        rank_tour: [],
        rank_season: []
      };
      ["rank_big","rank_small","rank_tour","rank_season"].forEach(key => {
        const box = document.querySelector(`[data-badge="${key}"]`);
        if (!box) return;
        box.innerHTML = "";
        const arr = (badges[key] || []).filter(Boolean);
        if (!arr.length) {
          const span = document.createElement("span");
          span.className = "badge-pill";
          span.textContent = "아직 없음";
          box.appendChild(span);
          return;
        }
        arr.forEach(name => {
          const pill = document.createElement("span");
          pill.className = "badge-pill";
          pill.textContent = name;
          const x = document.createElement("span");
          x.className = "x";
          x.textContent = "✕";
          x.addEventListener("click", () => {
            state.season.badges[key] = (state.season.badges[key] || []).filter(n => n !== name);
            renderBadges(state);
          });
          pill.appendChild(x);
          box.appendChild(pill);
        });
      });
    }

    function addBadges(state, cat, names) {
      if (!state.season) state.season = {
        id: genSeasonId(),
        startedAt: new Date().toISOString(),
        badges: {
          rank_big: [],
          rank_small: [],
          rank_tour: [],
          rank_season: []
        }
      };
      const current = state.season.badges[cat] || [];
      const add = names.map(s => s.trim()).filter(Boolean);
      const merged = [...current, ...add];
      state.season.badges[cat] = Array.from(new Set(merged));
      renderBadges(state);
    }

    // ===== 전체 리셋 =====
    function resetAll(state) {
      if (!confirm("랭킹 + 빙고를 전체 초기화할까요? (시즌 뱃지는 유지됩니다)")) return;
      const keepSeason = state.season;
      const fresh = createDefaultState();
      fresh.season = keepSeason;
      Object.assign(state, fresh);
      fillRankInputs(state);
      renderBingoEditor(state);
      renderBadges(state);
    }

    // ===== 비밀번호 / 게이트 =====
    function updateGateView() {
      const hash = localStorage.getItem(ADMIN_HASH_KEY);
      if (!hash) {
        $("#gateSetup").style.display = "block";
        $("#gateLogin").style.display = "none";
      } else {
        $("#gateSetup").style.display = "none";
        $("#gateLogin").style.display = "block";
      }
    }

    function togglePanel(show) {
      $("#panel").style.display = show ? "block" : "none";
    }

    async function handleSetPw() {
      const a = $("#newPw").value.trim();
      const b = $("#newPw2").value.trim();
      if (a.length < 6) { alert("비밀번호는 6자 이상 권장합니다."); return; }
      if (a !== b) { alert("비밀번호 확인이 일치하지 않습니다."); return; }
      const h = await sha256(a);
      localStorage.setItem(ADMIN_HASH_KEY, h);
      $("#newPw").value = "";
      $("#newPw2").value = "";
      alert("비밀번호가 설정되었습니다. 아래 로그인 영역에서 다시 입장해주세요.");
      updateGateView();
    }

    async function handleLogin(onSuccess) {
      const pw = $("#pw").value;
      const saved = localStorage.getItem(ADMIN_HASH_KEY);
      if (!saved) { alert("먼저 비밀번호를 설정해주세요."); return; }
      const h = await sha256(pw);
      if (h === saved) {
        $("#pw").value = "";
        localStorage.removeItem(ATTEMPT_KEY);
        $("#gate").style.display = "none";
        togglePanel(true);
        onSuccess();
      } else {
        const cur = parseInt(localStorage.getItem(ATTEMPT_KEY) || "0", 10) + 1;
        localStorage.setItem(ATTEMPT_KEY, String(cur));
        $("#gateMsg").textContent = `비밀번호가 올바르지 않습니다. (시도 ${cur}회)`;
      }
    }

    async function handleChangePw() {
      const cur = $("#curPw").value.trim();
      const a = $("#npw1").value.trim();
      const b = $("#npw2").value.trim();
      const saved = localStorage.getItem(ADMIN_HASH_KEY);
      if (!saved) { alert("먼저 기존 비밀번호를 설정해주세요."); return; }
      const hCur = await sha256(cur);
      if (hCur !== saved) { alert("현재 비밀번호가 올바르지 않습니다."); return; }
      if (a.length < 6) { alert("새 비밀번호는 6자 이상 권장합니다."); return; }
      if (a !== b) { alert("새 비밀번호 확인이 일치하지 않습니다."); return; }
      const hNew = await sha256(a);
      localStorage.setItem(ADMIN_HASH_KEY, hNew);
      $("#curPw").value = "";
      $("#npw1").value = "";
      $("#npw2").value = "";
      alert("비밀번호가 변경되었습니다.");
      $("#changePwCard").style.display = "none";
    }

    let state = null;

    document.addEventListener("DOMContentLoaded", async () => {
      updateGateView();
      togglePanel(false);

      document.addEventListener("keydown", (e) => {
        if (e.altKey && e.key.toLowerCase() === "a") {
          const gate = $("#gate");
          if (gate.style.display === "none") gate.style.display = "block";
          else gate.style.display = "none";
        }
      });

      $("#btnSetPw").addEventListener("click", handleSetPw);
      $("#btnEnter").addEventListener("click", () => handleLogin(async () => {
        state = await loadState();
        updateLastSaved(state);
        fillRankInputs(state);
        renderBingoEditor(state);
        renderBadges(state);
      }));
      $("#btnChangePw").addEventListener("click", () => {
        const card = $("#changePwCard");
        card.style.display = card.style.display === "none" ? "block" : "none";
      });
      $("#btnApplyPw").addEventListener("click", handleChangePw);

      $("#btnResetBingo").addEventListener("click", () => resetBingo(state));
      $("#btnBadgeAdd").addEventListener("click", () => {
        const cat = $("#badgeCat").value;
        const names = $("#badgeNames").value.split(",");
        addBadges(state, cat, names);
        $("#badgeNames").value = "";
      });
      $("#btnResetAll").addEventListener("click", () => resetAll(state));
      $("#btnSave").addEventListener("click", async () => {
        collectRankState(state);
        await saveState(state);
      });
    });
  </script>
</body>
</html>
