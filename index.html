<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹ ì´Œ ê¾¼ ë‚šì‹œì¹´í˜ ê³µì‹ ë­í‚¹ë³´ë“œ</title>

  <!-- í°íŠ¸ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg1: #020617;
      --bg2: #020920;
      --card: rgba(15, 23, 42, 0.95);
      --card-soft: rgba(15, 23, 42, 0.85);
      --line: rgba(56, 189, 248, 0.55);
      --line-soft: rgba(148, 163, 184, 0.6);
      --neon: #38bdf8;
      --neon-soft: #0ea5e9;
      --danger: #fb7185;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --radius: 18px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
    }

    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: "Noto Sans KR", system-ui, -apple-system, BlinkMacSystemFont;
      background:
        radial-gradient(circle at 0% 0%, #0f172a 0, transparent 55%),
        radial-gradient(circle at 100% 100%, #020617 0, transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }

    .wrap {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 16px;
    }

    .logo {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #0ea5e9 40%, #0369a1 70%, #020617 100%);
      box-shadow:
        0 0 18px rgba(56, 189, 248, 0.9),
        0 0 40px rgba(8, 47, 73, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0f172a;
      font-family: "Jua";
      font-size: 22px;
    }

    .title-box {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-main {
      font-family: "Jua";
      font-size: 22px;
      letter-spacing: 0.03em;
    }

    .title-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .header-right {
      margin-left: auto;
      text-align: right;
      font-size: 11px;
      color: var(--muted);
    }

    .header-right strong {
      color: var(--neon);
      font-weight: 600;
    }

    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(12, 1fr);
    }

    .card {
      grid-column: span 12;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      padding: 14px 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      border: 1px solid transparent;
      background:
        linear-gradient(135deg, rgba(56, 189, 248, 0.5), transparent 35%, transparent 65%, rgba(59, 130, 246, 0.4)) border-box;
      mask:
        linear-gradient(#000 0 0) padding-box,
        linear-gradient(#000 0 0);
      mask-composite: exclude;
      opacity: 0.6;
      pointer-events: none;
    }

    .card-soft {
      background: var(--card-soft);
    }

    @media (min-width: 768px) {
      .card-rank { grid-column: span 3; }
      .card-bingo { grid-column: span 12; }
      .card-season-badge { grid-column: span 12; }
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title {
      font-family: "Jua";
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--muted);
    }

    .tag-primary {
      border-color: rgba(56, 189, 248, 0.8);
      color: var(--neon);
      background: rgba(8, 47, 73, 0.7);
    }

    .tag-outline {
      border-color: rgba(148, 163, 184, 0.7);
      color: var(--muted);
      background: rgba(15, 23, 42, 0.8);
    }

    .pill-small {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--muted);
    }

    .btn-link {
      margin-left: auto;
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(56, 189, 248, 0.6);
      color: var(--neon);
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.12), transparent 55%);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-link:hover {
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.4);
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.2), transparent 60%);
    }

    /* ======================
       ë­í‚¹ í•œ ì¤„ ë ˆì´ì•„ì›ƒ
       [ë©”ë‹¬+TOP] | ì´ë¦„ | ë¬´ê²Œ | ìƒí’ˆ
       ====================== */

    ol.ranklist {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    ol.ranklist li {
      display: grid;
      grid-template-columns:
        64px                  /* ë©”ë‹¬ + TOP4/5 */
        minmax(120px, 1.2fr)  /* ì´ë¦„ */
        minmax(60px, 0.5fr)   /* ë¬´ê²Œ(ì ìˆ˜) */
        minmax(360px, 3.3fr); /* ìƒí’ˆ - ë„“ê²Œ */
      align-items: center;
      column-gap: 10px;
      padding: 7px 10px;
      border-radius: 10px;
      font-size: 13px;
      background: rgba(15, 23, 42, 0.3);
      border: 1px solid transparent;
      margin-bottom: 4px;
    }

    .rank-left {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
    }

    .rank-medal {
      font-size: 18px;
      text-align: center;
      line-height: 1;
    }

    .chip-top {
      font-size: 10px;
      border-radius: 999px;
      padding: 1px 6px;
      border: 1px solid rgba(56, 189, 248, 0.7);
      color: var(--neon);
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 0 8px rgba(56, 189, 248, 0.4);
      white-space: nowrap;
    }

    .rank-name {
      font-weight: 600;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .rank-score {
      font-variant-numeric: tabular-nums;
      font-size: 12px;
      text-align: center;
      color: var(--neon);
      font-weight: 600;
      white-space: nowrap;
    }

    .rank-prize {
      font-size: 11px;
      color: var(--neon-soft);
      white-space: nowrap;    /* í•œ ì¤„ ê³ ì •, ë°ìŠ¤í¬íƒ‘ìš© */
    }

    /* grid-area í• ë‹¹ (ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒì—ì„œ ì‚¬ìš©) */
    .rank-left { grid-area: medal; }
    .rank-name { grid-area: name; }
    .rank-score { grid-area: score; }
    .rank-prize { grid-area: prize; }

    /* ===== ëª¨ë°”ì¼(ì„¸ë¡œ)ìš© : ìƒí’ˆë§Œ 2ì¤„ë¡œ ì•„ë˜ ì¤„ë¡œ ë‚´ë¦¬ê¸° ===== */
    @media (max-width: 768px) {
      ol.ranklist li {
        grid-template-columns: 56px minmax(0, 1.2fr) minmax(70px, 0.9fr);
        grid-template-rows: auto auto;
        grid-template-areas:
          "medal name score"
          "medal prize prize";
        row-gap: 2px;
      }
      .rank-name {
        font-size: 13px;
      }
      .rank-score {
        font-size: 12px;
        text-align: right;
      }
      .rank-prize {
        font-size: 11px;
        white-space: normal;   /* ëª¨ë°”ì¼ì—ì„œëŠ” ìƒí’ˆ ë‚´ìš© ì¤„ë°”ê¿ˆ í—ˆìš© */
      }
    }

    .empty {
      font-size: 12px;
      color: var(--muted);
      padding: 2px 0;
    }

    /* ë¹™ê³  */
    .bingo-head {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .bingo-remaining {
      margin-left: auto;
      font-size: 12px;
      color: var(--neon);
      font-weight: 600;
    }

    .bingo-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .bingo-cell {
      height: 70px;
      border-radius: 14px;
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.08), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      text-align: center;
      font-size: 12px;
      position: relative;
      overflow: hidden;
    }

    .bingo-cell.used {
      background: radial-gradient(circle at 100% 100%, rgba(148, 163, 184, 0.22), rgba(15, 23, 42, 0.95));
      color: rgba(148, 163, 184, 0.9);
      text-decoration: line-through;
    }

    .bingo-cell.used::after {
      content: "âœ•";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(148, 163, 184, 0.6);
      font-size: 26px;
      pointer-events: none;
    }

    .bingo-label {
      z-index: 1;
      font-weight: 600;
    }

    /* ì‹œì¦Œ ë±ƒì§€ ëª…ë‹¨ */
    .badge-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media (min-width: 880px) {
      .badge-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    .badge-card {
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.12), rgba(15, 23, 42, 0.96));
      border-radius: 14px;
      padding: 10px 10px 8px;
      border: 1px solid rgba(30, 64, 175, 0.8);
    }

    .badge-card-title {
      font-size: 13px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #e5e7eb;
    }

    .badge-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      max-height: 88px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.6);
      background: rgba(15, 23, 42, 0.95);
      color: var(--neon);
      white-space: nowrap;
    }

    .badge-empty {
      border-style: dashed;
      border-color: rgba(148, 163, 184, 0.7);
      color: var(--muted);
    }

    .season-pill {
      margin-left: 6px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.75);
      color: var(--muted);
    }

    .footer {
      margin-top: 22px;
      font-size: 11px;
      text-align: center;
      color: var(--muted);
    }

    .footer code {
      color: var(--neon);
    }

    /* ===== ì‹œì¦Œì „ ì „ì²´ ë­í‚¹ ëª¨ë‹¬ ===== */
    .modal {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.06), transparent 60%),
                  radial-gradient(circle at 100% 100%, rgba(15, 23, 42, 0.9), rgba(2, 6, 23, 0.98));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      backdrop-filter: blur(10px);
    }

    .modal.open {
      display: flex;
    }

    .modal-dialog {
      width: min(620px, 92vw);
      max-height: 70vh;
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.16), rgba(15, 23, 42, 0.98));
      border-radius: 18px;
      box-shadow: 0 24px 80px rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(56, 189, 248, 0.7);
      padding: 14px 16px 16px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .modal-title {
      font-family: "Jua";
      font-size: 16px;
    }

    .modal-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.7);
      color: var(--neon);
      background: rgba(8, 47, 73, 0.7);
    }

    .modal-close {
      margin-left: auto;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 15px;
    }

    .modal-close:hover {
      border-color: rgba(248, 250, 252, 0.9);
      color: #f9fafb;
      box-shadow: 0 0 18px rgba(248, 250, 252, 0.7);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding-right: 2px;
      margin-top: 4px;
    }

    .modal-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .modal-list li {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(30, 64, 175, 0.5);
      font-size: 13px;
    }

    .modal-list li + li {
      margin-top: 4px;
    }

    .modal-rank-no {
      width: 26px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: rgba(148, 163, 184, 0.9);
      font-size: 12px;
    }

    .modal-rank-name {
      font-weight: 600;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .modal-rank-score {
      font-variant-numeric: tabular-nums;
      color: var(--muted);
      min-width: 60px;
      text-align: right;
      font-size: 12px;
    }

    .modal-empty {
      font-size: 12px;
      color: var(--muted);
      padding: 6px 0;
    }

    .modal-hint {
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">ê¾¼</div>
      <div class="title-box">
        <div class="title-main">ì‹ ì´Œ ê¾¼ ë‚šì‹œì¹´í˜ ê³µì‹ ë­í‚¹ë³´ë“œ</div>
        <div class="title-sub">ì˜¤ëŠ˜ì˜ ê¸°ë¡ì´ ê¶ê¸ˆí•˜ë‹¤ë©´? ì‹¤ì‹œê°„ ë­í‚¹ & ì¹˜í‚¨ë¹™ê³  í˜„í™©</div>
      </div>
      <div class="header-right">
        <div>ì—…ë°ì´íŠ¸: <strong id="lastUpdated">-</strong></div>
        <div style="margin-top:2px;font-size:10px;">ë°ì´í„° ë™ê¸°í™”: Supabase</div>
      </div>
    </header>

    <div class="grid">
      <!-- ëŒ€ë¬¼ì™• -->
      <section class="card card-rank">
        <div class="card-header">
          <div class="card-title">
            <span class="title-label" data-title="rank_big">ëŒ€ë¬¼ì™•</span>
            <span class="tag tag-primary">Top 5</span>
          </div>
        </div>
        <ol class="ranklist" data-key="rank_big"></ol>
      </section>

      <!-- ì†Œë¬¼ì™• -->
      <section class="card card-rank">
        <div class="card-header">
          <div class="card-title">
            <span class="title-label" data-title="rank_small">ì†Œë¬¼ì™•</span>
            <span class="tag tag-primary">Top 5</span>
          </div>
        </div>
        <ol class="ranklist" data-key="rank_small"></ol>
      </section>

      <!-- ì²œí•˜ì œì¼ ë‚šì‹œëŒ€íšŒ -->
      <section class="card card-rank">
        <div class="card-header">
          <div class="card-title">
            <span class="title-label" data-title="rank_tour">ì²œí•˜ì œì¼ ë‚šì‹œëŒ€íšŒ</span>
            <span class="tag tag-primary">Top 5</span>
          </div>
        </div>
        <ol class="ranklist" data-key="rank_tour"></ol>
      </section>

      <!-- ì‹œì¦Œì „ -->
      <section class="card card-rank">
        <div class="card-header">
          <div class="card-title">
            <span class="title-label" data-title="rank_season">ì‹œì¦Œì „</span>
            <span class="tag tag-primary">Top 5</span>
          </div>
          <button class="btn-link" id="btnSeasonAll">
            ì „ì²´ë³´ê¸° <span class="pill-small">ìµœëŒ€ 100ëª…</span>
          </button>
        </div>
        <ol class="ranklist" data-key="rank_season"></ol>
      </section>

      <!-- ì¹˜í‚¨ë¹™ê³  -->
      <section class="card card-bingo">
        <div class="bingo-head">
          <div class="card-title">ì¹˜í‚¨ë¹™ê³  <span class="tag tag-outline">4 Ã— 4</span></div>
          <div class="bingo-remaining" id="bingoRemain">ë‚¨ì€ ì¹¸: -</div>
        </div>
        <div class="bingo-grid" id="bingoGrid"></div>
      </section>

      <!-- ì‹œì¦Œ ë±ƒì§€ ëª…ë‹¨ -->
      <section class="card card-season-badge card-soft">
        <div class="card-header">
          <div class="card-title">
            ì‹œì¦Œ ë±ƒì§€ ëª…ë‹¨
            <span class="season-pill" id="seasonId">-</span>
          </div>
        </div>
        <div class="badge-grid">
          <div class="badge-card">
            <div class="badge-card-title">ëŒ€ë¬¼ì™•</div>
            <div class="badge-list" data-badge="rank_big"></div>
          </div>
          <div class="badge-card">
            <div class="badge-card-title">ì†Œë¬¼ì™•</div>
            <div class="badge-list" data-badge="rank_small"></div>
          </div>
          <div class="badge-card">
            <div class="badge-card-title">ì²œí•˜ì œì¼ ëŒ€íšŒ</div>
            <div class="badge-list" data-badge="rank_tour"></div>
          </div>
          <div class="badge-card">
            <div class="badge-card-title">ì‹œì¦Œì „</div>
            <div class="badge-list" data-badge="rank_season"></div>
          </div>
        </div>
      </section>
    </div>

    <div class="footer">
      ë„¤ì˜¨ ê°ì„± ë‹¤í¬ í…Œë§ˆ Â· ë¸Œëœë“œ í†¤: ë² ì´ì§€ & íŒŒìŠ¤í…” ë¸”ë£¨ & ë‹¤í¬ ë„¤ì˜¨ ì¡°í•© Â· íš¨ê³¼:
      <code>text-shadow: 0 0 10px #38bdf8</code>
    </div>
  </div>

  <!-- ì‹œì¦Œì „ ì „ì²´ ë­í‚¹ ëª¨ë‹¬ -->
  <div class="modal" id="seasonModal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="seasonModalTitle">
      <div class="modal-header">
        <div class="modal-title" id="seasonModalTitle">ì‹œì¦Œì „ ì „ì²´ ë­í‚¹</div>
        <div class="modal-badge">ìµœëŒ€ 100ëª…</div>
        <button class="modal-close" id="seasonModalClose" aria-label="ë‹«ê¸°">âœ•</button>
      </div>
      <div class="modal-body">
        <ul class="modal-list" id="seasonModalList"></ul>
        <div class="modal-empty" id="seasonModalEmpty" style="display:none;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
      <div class="modal-hint">
        â€» ì‹œì¦Œì „ ì „ì²´ ë­í‚¹ì€ ìš´ì˜ìê°€ ì…ë ¥í•œ ìˆœì„œê°€ ì•„ë‹Œ, <strong>ì ìˆ˜(ìˆ«ì) ê¸°ì¤€ ìë™ ë‚´ë¦¼ì°¨ìˆœ</strong>ìœ¼ë¡œ ì •ë ¬ë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <!-- ===== JS: Supabase + ë Œë”ë§ ===== -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://vuadzeocolgypuapcvsz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1YWR6ZW9jb2xneXB1YXBjdnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMzE4MTksImV4cCI6MjA3ODYwNzgxOX0.Whi2uUQExqo8a5YF9lKCWhBcF6I29fdrrN-byDWZf2I';
    const TABLE = 'kkun_state';
    const ROW_ID = 'global';

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const $ = (sel, el = document) => el.querySelector(sel);
    const $$ = (sel, el = document) => [...el.querySelectorAll(sel)];

    function createDefaultState() {
      const bingo = Array.from({ length: 16 }, () => ({ label: '', used: false }));
      return {
        lastUpdated: null,
        season: {
          id: genSeasonId(),
          startedAt: new Date().toISOString(),
          badges: {
            rank_big: [],
            rank_small: [],
            rank_tour: [],
            rank_season: [],
          },
        },
        rank_big: [],
        rank_small: [],
        rank_tour: [],
        rank_season: [],
        bingo,
        titles: {
          rank_big: 'ëŒ€ë¬¼ì™•',
          rank_small: 'ì†Œë¬¼ì™•',
          rank_tour: 'ì²œí•˜ì œì¼ ë‚šì‹œëŒ€íšŒ',
          rank_season: 'ì‹œì¦Œì „',
        },
      };
    }

    function genSeasonId() {
      const d = new Date();
      return `${d.getFullYear()} Q${Math.floor(d.getMonth() / 3) + 1}`;
    }

    function toNumber(v) {
      if (v == null) return 0;
      const n = parseFloat(String(v).replace(/[^0-9.-]/g, ''));
      return Number.isNaN(n) ? 0 : n;
    }

    const PRIZE_CONFIG = {
      rank_big: ['50,000P','30,000P','10,000P','5,000P','3,000P'],
      rank_small: ['50,000P','30,000P','10,000P','5,000P','3,000P'],
      rank_tour: [
        '1ì‹œê°„ í• ì¸ê¶Œ 3ì¥',
        '1ì‹œê°„ í• ì¸ê¶Œ 1ì¥',
        '4,000ì› í• ì¸ê¶Œ 1ì¥',
        '3,000ì› í• ì¸ê¶Œ 1ì¥',
        '2,000ì› í• ì¸ê¶Œ 1ì¥',
      ],
      rank_season: [
        '10ë§ŒP + 1ì‹œê°„ í• ì¸ê¶Œ 3ì¥',
        '7ë§ŒP + 1ì‹œê°„ í• ì¸ê¶Œ 2ì¥',
        '3ë§ŒP + 1ë§Œì› í• ì¸ê¶Œ 1ì¥',
      ],
    };

    const SORT_CONFIG = {
      rank_big: 'desc',
      rank_tour: 'desc',
      rank_season: 'desc',
      rank_small: 'asc',
    };

    async function loadStateFromSupabase() {
      try {
        const { data, error } = await supabase
          .from(TABLE)
          .select('state')
          .eq('id', ROW_ID)
          .single();

        if (error) {
          console.error('[index] Supabase ì˜¤ë¥˜:', error);
          return createDefaultState();
        }

        if (!data || !data.state || Object.keys(data.state).length === 0) {
          return createDefaultState();
        }

        return data.state;
      } catch (err) {
        console.error('[index] ì˜ˆì™¸:', err);
        return createDefaultState();
      }
    }

    function renderTitles(state) {
      const defaultTitles = {
        rank_big: 'ëŒ€ë¬¼ì™•',
        rank_small: 'ì†Œë¬¼ì™•',
        rank_tour: 'ì²œí•˜ì œì¼ ë‚šì‹œëŒ€íšŒ',
        rank_season: 'ì‹œì¦Œì „',
      };

      const titles = state.titles || {};
      $$('.title-label').forEach((el) => {
        const key = el.getAttribute('data-title');
        const titleText = titles[key] || defaultTitles[key] || el.textContent;
        el.textContent = titleText;
      });
    }

    function renderRanks(state) {
      $$('.ranklist').forEach((ol) => {
        const key = ol.getAttribute('data-key');
        const raw = state[key] || [];
        const sortOrder = SORT_CONFIG[key] || 'desc';

        const sorted = raw
          .slice()
          .sort((a, b) => {
            const na = toNumber(a.score);
            const nb = toNumber(b.score);
            return sortOrder === 'asc' ? na - nb : nb - na;
          });

        const top5 = sorted.slice(0, 5);
        const rewards = PRIZE_CONFIG[key] || [];

        ol.innerHTML = '';
        if (top5.length === 0) {
          const li = document.createElement('li');
          li.className = 'empty';
          li.textContent = 'ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
          ol.appendChild(li);
          return;
        }

        top5.forEach((item, idx) => {
          const medal =
            idx === 0 ? 'ğŸ¥‡' :
            idx === 1 ? 'ğŸ¥ˆ' :
            idx === 2 ? 'ğŸ¥‰' : '';

          const prizeText = rewards[idx] || '';
          const chipText = idx === 3 ? 'TOP 4' : idx === 4 ? 'TOP 5' : '';

          const li = document.createElement('li');
          li.innerHTML = `
            <div class="rank-left">
              <span class="rank-medal">${medal}</span>
              ${chipText ? `<span class="chip-top">${chipText}</span>` : ''}
            </div>
            <span class="rank-name">${item.name || '-'}</span>
            <span class="rank-score">${item.score || ''}</span>
            <span class="rank-prize">${prizeText}</span>
          `;
          ol.appendChild(li);
        });
      });
    }

    function renderBingo(state) {
      const grid = document.getElementById('bingoGrid');
      grid.innerHTML = '';
      const cells = state.bingo || [];
      let remain = 0;

      cells.forEach((cell) => {
        const div = document.createElement('div');
        div.className = 'bingo-cell' + (cell.used ? ' used' : '');
        const label = document.createElement('div');
        label.className = 'bingo-label';
        label.textContent = cell.label || 'â€”';
        div.appendChild(label);
        grid.appendChild(div);
        if (!cell.used) remain += 1;
      });

      document.getElementById('bingoRemain').textContent = `ë‚¨ì€ ì¹¸: ${remain}`;
    }

    function renderBadges(state) {
      const season = state.season || {};
      document.getElementById('seasonId').textContent = season.id || '-';

      const badges = season.badges || {};
      ['rank_big', 'rank_small', 'rank_tour', 'rank_season'].forEach((key) => {
        const box = document.querySelector(`[data-badge="${key}"]`);
        if (!box) return;
        box.innerHTML = '';

        const arr = (badges[key] || []).filter(Boolean);
        if (arr.length === 0) {
          const span = document.createElement('span');
          span.className = 'badge badge-empty';
          span.textContent = 'ì•„ì§ ì—†ìŒ';
          box.appendChild(span);
          return;
        }

        arr.forEach((name) => {
          const span = document.createElement('span');
          span.className = 'badge';
          span.textContent = name;
          box.appendChild(span);
        });
      });
    }

    function renderSeasonModal(state) {
      const modalList = document.getElementById('seasonModalList');
      const empty = document.getElementById('seasonModalEmpty');
      modalList.innerHTML = '';

      const raw = state.rank_season || [];
      const sorted = raw
        .slice()
        .sort((a, b) => toNumber(b.score) - toNumber(a.score))
        .slice(0, 100);

      if (sorted.length === 0) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      sorted.forEach((item, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span class="modal-rank-no">${idx + 1}</span>
          <span class="modal-rank-name">${item.name || '-'}</span>
          <span class="modal-rank-score">${item.score || ''}</span>
        `;
        modalList.appendChild(li);
      });
    }

    function setLastUpdated(state) {
      const t = state.lastUpdated
        ? new Date(state.lastUpdated).toLocaleString('ko-KR')
        : '-';
      document.getElementById('lastUpdated').textContent = t;
    }

    function setupSeasonModal(stateRef) {
      const modal = document.getElementById('seasonModal');
      const openBtn = document.getElementById('btnSeasonAll');
      const closeBtn = document.getElementById('seasonModalClose');

      function open() {
        renderSeasonModal(stateRef.current);
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
      }

      function close() {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
      }

      openBtn.addEventListener('click', open);
      closeBtn.addEventListener('click', close);

      modal.addEventListener('click', (e) => {
        if (e.target === modal) close();
      });

      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('open')) {
          close();
        }
      });
    }

    const stateRef = { current: createDefaultState() };

    async function refresh() {
      const st = await loadStateFromSupabase();
      stateRef.current = st;
      renderTitles(st);
      renderRanks(st);
      renderBingo(st);
      renderBadges(st);
      setLastUpdated(st);
    }

    setupSeasonModal(stateRef);
    refresh();
    setInterval(refresh, 30000);
  </script>
</body>
</html>
