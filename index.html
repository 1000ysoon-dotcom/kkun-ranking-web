<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹ ì´Œ ê¾¼ ë‚šì‹œì¹´í˜ ê³µì‹ ë­í‚¹ë³´ë“œ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-main: radial-gradient(circle at top left, #0f172a 0, #020617 45%, #000 100%);
      --card-bg: rgba(15,23,42,0.96);
      --card-border: rgba(148,163,184,0.3);
      --blue: #38bdf8;
      --blue-soft: rgba(56,189,248,0.16);
      --text-main: #e5e7eb;
      --text-muted: #64748b;
      --danger: #fb7185;
      --radius-lg: 18px;
      --shadow-soft: 0 22px 45px rgba(15,23,42,0.9);
    }
    * { box-sizing:border-box; }
    html,body {
      margin:0;
      padding:0;
      background:#020617;
      background-image:var(--bg-main);
      min-height:100%;
      color:var(--text-main);
      font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    body {
      display:flex;
      justify-content:center;
      padding:32px 16px 40px;
    }
    .wrap {
      width:100%;
      max-width:1280px;
    }

    header {
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:18px;
    }
    .logo {
      width:52px;
      height:52px;
      border-radius:999px;
      background:radial-gradient(circle at 20% 20%, #facc15, #0ea5e9 45%, #0f172a 80%);
      box-shadow:0 0 18px rgba(56,189,248,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:24px;
      color:#0b1120;
    }
    .title-area h1 {
      margin:0;
      font-size:22px;
      font-weight:700;
    }
    .title-area p {
      margin:2px 0 0;
      font-size:13px;
      color:var(--text-muted);
    }
    .status {
      margin-left:auto;
      text-align:right;
      font-size:11px;
      color:var(--text-muted);
    }
    .status span.badge {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.8);
      border:1px solid rgba(56,189,248,0.4);
      font-size:11px;
      margin-bottom:4px;
    }
    .status-dot {
      width:6px;
      height:6px;
      border-radius:999px;
      background:#4ade80;
      box-shadow:0 0 6px #22c55e;
    }

    /* layout */
    .grid-top {
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:14px;
      margin-bottom:18px;
    }
    .card {
      background:var(--card-bg);
      border-radius:var(--radius-lg);
      padding:14px 16px 13px;
      border:1px solid var(--card-border);
      box-shadow:var(--shadow-soft);
      position:relative;
      overflow:hidden;
    }
    .card::before {
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at top, rgba(56,189,248,0.12), transparent 55%);
      opacity:0.4;
      pointer-events:none;
    }
    .card-inner { position:relative; z-index:1; }

    .card-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .card-title {
      font-size:15px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .pill {
      display:inline-flex;
      align-items:center;
      padding:1px 7px;
      border-radius:999px;
      background:var(--blue-soft);
      border:1px solid rgba(56,189,248,0.5);
      color:var(--blue);
      font-size:11px;
      font-weight:600;
    }
    .pill span.small { font-size:10px; margin-left:4px; opacity:0.8; }

    .rank-empty {
      font-size:12px;
      color:var(--text-muted);
      margin-top:6px;
    }
    ol.ranklist {
      margin:4px 0 0;
      padding:0;
      list-style:none;
      font-size:13px;
    }
    ol.ranklist li {
      display:flex;
      align-items:center;
      gap:8px;
      padding:4px 0;
    }
    .rank-medal {
      width:20px;
      text-align:center;
      font-size:15px;
    }
    .rank-name { font-weight:500; }
    .rank-score {
      margin-left:auto;
      font-variant-numeric:tabular-nums;
      color:#e5e7eb;
      font-size:13px;
    }
    .chip-small {
      margin-left:6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      padding:1px 6px;
      font-size:10px;
      color:var(--text-muted);
    }

    /* ì‹œì¦Œ ì „ì²´ë³´ê¸° ë²„íŠ¼ */
    .btn-sm {
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.8);
      color:var(--text-main);
      font-size:11px;
      padding:4px 8px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }
    .btn-sm span.sub { font-size:10px; color:var(--text-muted); }

    /* bingo */
    .bingo-card {
      margin-bottom:18px;
    }
    .bingo-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .bingo-title {
      font-size:15px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .bingo-remaining {
      font-size:13px;
      color:var(--blue);
      font-weight:500;
    }
    .bingo-grid {
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
    }
    .bingo-cell {
      height:70px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.4);
      background:radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.96));
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      text-align:center;
      padding:4px;
      position:relative;
    }
    .bingo-cell.used {
      opacity:0.5;
      text-decoration:line-through;
    }
    .bingo-cell.used::after {
      content:"âœ•";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      color:rgba(148,163,184,0.9);
      pointer-events:none;
    }

    /* ì‹œì¦Œ ë±ƒì§€ */
    .season-card .card-header { margin-bottom:10px; }
    .season-badges {
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
      font-size:12px;
    }
    .badge-col-title {
      font-size:12px;
      color:var(--text-muted);
      margin-bottom:4px;
    }
    .badge-list {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .badge-pill {
      border-radius:999px;
      border:1px solid rgba(56,189,248,0.5);
      background:rgba(15,23,42,0.9);
      padding:2px 8px;
      font-size:11px;
    }

    .footer-note {
      margin-top:10px;
      font-size:11px;
      color:var(--text-muted);
      text-align:right;
    }

    /* ëª¨ë‹¬ */
    .modal-backdrop {
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(15,23,42,0.85);
      backdrop-filter:blur(10px);
      z-index:50;
    }
    .modal-backdrop.show { display:flex; }
    .modal-panel {
      width:100%;
      max-width:720px;
      background:radial-gradient(circle at top, #020617, #020617 45%, #000 100%);
      border-radius:20px;
      border:1px solid rgba(56,189,248,0.35);
      box-shadow:0 32px 80px rgba(15,23,42,0.95);
      padding:16px 18px 14px;
      color:var(--text-main);
    }
    .modal-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .modal-title {
      font-size:16px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .modal-sub { font-size:11px; color:var(--text-muted); }
    .modal-close {
      border-radius:999px;
      width:26px;
      height:26px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      color:var(--text-main);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:13px;
    }
    .modal-body {
      margin-top:6px;
      max-height:420px;
      overflow:auto;
      padding-right:4px;
    }
    table.full-rank {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    table.full-rank thead { position:sticky; top:0; background:#020617; }
    table.full-rank th,
    table.full-rank td {
      padding:6px 4px;
      border-bottom:1px solid rgba(30,64,175,0.6);
    }
    table.full-rank th {
      font-size:11px;
      text-align:left;
      color:var(--text-muted);
      font-weight:500;
    }
    table.full-rank td.num { width:38px; text-align:right; padding-right:8px; color:var(--text-muted); }
    table.full-rank td.score { text-align:right; font-variant-numeric:tabular-nums; }
    .empty-row { text-align:center; color:var(--text-muted); padding:12px 0; }

    @media (max-width:900px) {
      .grid-top { grid-template-columns:repeat(2,minmax(0,1fr)); }
      .season-badges { grid-template-columns:repeat(2,minmax(0,1fr)); }
    }
    @media (max-width:640px) {
      body { padding:20px 10px 28px; }
      header { flex-direction:column; align-items:flex-start; gap:8px; }
      .status { margin-left:0; text-align:left; }
      .grid-top { grid-template-columns:repeat(1,minmax(0,1fr)); }
      .modal-panel { max-width:100%; margin:0 8px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">ê¾¼</div>
      <div class="title-area">
        <h1>ì‹ ì´Œ ê¾¼ ë‚šì‹œì¹´í˜ ê³µì‹ ë­í‚¹ë³´ë“œ</h1>
        <p>ì˜¤ëŠ˜ì˜ ê¸°ë¡ì´ ê¶ê¸ˆí•˜ë‹¤ë©´? ì‹¤ì‹œê°„ ë­í‚¹ &amp; ì¹˜í‚¨ë¹™ê³  í˜„í™©</p>
      </div>
      <div class="status">
        <span class="badge"><span class="status-dot"></span> ì‹¤ì‹œê°„ ì—°ë™ <span style="opacity:.7;">Â· Supabase</span></span><br>
        <div>ì—…ë°ì´íŠ¸: <span id="updatedAt">-</span></div>
      </div>
    </header>

    <section class="grid-top">
      <article class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">ëŒ€ë¬¼ì™• <span class="pill">Top 5</span></div>
          </div>
          <ol class="ranklist" data-rank="rank_big"></ol>
          <div class="rank-empty" data-empty-for="rank_big">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </article>

      <article class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">ì†Œë¬¼ì™• <span class="pill">Top 5</span></div>
          </div>
          <ol class="ranklist" data-rank="rank_small"></ol>
          <div class="rank-empty" data-empty-for="rank_small">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </article>

      <article class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">ì²œí•˜ì œì¼ ë‚šì‹œëŒ€íšŒ <span class="pill">Top 5</span></div>
          </div>
          <ol class="ranklist" data-rank="rank_tour"></ol>
          <div class="rank-empty" data-empty-for="rank_tour">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </article>

      <article class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">ì‹œì¦Œì „ <span class="pill">Top 5</span></div>
            <button class="btn-sm" id="btnSeasonFull">
              ì „ì²´ë³´ê¸° <span class="sub">ìµœëŒ€ 100ëª…</span>
            </button>
          </div>
          <ol class="ranklist" data-rank="rank_season"></ol>
          <div class="rank-empty" data-empty-for="rank_season">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </article>
    </section>

    <section class="card bingo-card">
      <div class="card-inner">
        <div class="bingo-header">
          <div class="bingo-title">ì¹˜í‚¨ë¹™ê³  <span class="pill">4 Ã— 4</span></div>
          <div class="bingo-remaining">ë‚¨ì€ ì¹¸: <span id="bingoRemain">-</span></div>
        </div>
        <div class="bingo-grid" id="bingoGrid"></div>
      </div>
    </section>

    <section class="card season-card">
      <div class="card-inner">
        <div class="card-header">
          <div class="card-title">ì‹œì¦Œ ë±ƒì§€ ëª…ë‹¨</div>
          <div class="pill">ì‹œì¦Œ <span id="seasonLabel" class="small">-</span></div>
        </div>
        <div class="season-badges">
          <div>
            <div class="badge-col-title">ëŒ€ë¬¼ì™•</div>
            <div class="badge-list" data-badge="rank_big"></div>
          </div>
          <div>
            <div class="badge-col-title">ì†Œë¬¼ì™•</div>
            <div class="badge-list" data-badge="rank_small"></div>
          </div>
          <div>
            <div class="badge-col-title">ì²œí•˜ì œì¼ ëŒ€íšŒ</div>
            <div class="badge-list" data-badge="rank_tour"></div>
          </div>
          <div>
            <div class="badge-col-title">ì‹œì¦Œì „</div>
            <div class="badge-list" data-badge="rank_season"></div>
          </div>
        </div>
        <div class="footer-note">ë„¤ì˜¨ ê°ì„± ë‹¤í¬ í…Œë§ˆ Â· ë¸Œëœë“œ í†¤: ë² ì´ì§€ Ã— íŒŒìŠ¤í…” ë¸”ë£¨</div>
      </div>
    </section>
  </div>

  <!-- ì‹œì¦Œì „ ì „ì²´ ë­í‚¹ ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="seasonModal">
    <div class="modal-panel" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title">
          ì‹œì¦Œì „ ì „ì²´ ë­í‚¹
          <span class="pill">ìµœëŒ€ 100ëª…</span>
        </div>
        <button class="modal-close" id="seasonModalClose" aria-label="ë‹«ê¸°">âœ•</button>
      </div>
      <div class="modal-sub">â€» ì ìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ Â· ë™ì  ì‹œ ë¨¼ì € ì…ë ¥ëœ ìˆœì„œëŒ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
      <div class="modal-body">
        <table class="full-rank">
          <thead>
            <tr>
              <th style="width:40px; text-align:right; padding-right:8px;">#</th>
              <th>ì´ë¦„</th>
              <th style="text-align:right;">ì ìˆ˜</th>
            </tr>
          </thead>
          <tbody id="seasonFullBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://vuadzeocolgypuapcvsz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1YWR6ZW9jb2xneXB1YXBjdnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMzE4MTksImV4cCI6MjA3ODYwNzgxOX0.Whi2uUQExqo8a5YF9lKCWhBcF6I29fdrrN-byDWZf2I";
    const TABLE_NAME = "kkun_state";
    const ROW_ID = "global";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function createDefaultState() {
      const bingo = Array.from({length:16}, () => ({ label:"", used:false }));
      return {
        lastUpdated: null,
        rank_big: [],
        rank_small: [],
        rank_tour: [],
        rank_season: [],
        bingo,
        season: {
          id: genSeasonId(),
          startedAt: new Date().toISOString(),
          badges: {
            rank_big: [],
            rank_small: [],
            rank_tour: [],
            rank_season: []
          }
        }
      };
    }

    function genSeasonId() {
      const d = new Date();
      const q = Math.floor(d.getMonth() / 3) + 1;
      return `${d.getFullYear()} Q${q}`;
    }

    function toNumber(v) {
      if (v === null || v === undefined) return 0;
      const n = parseFloat(String(v).replace(/[^0-9.-]/g, ""));
      return isNaN(n) ? 0 : n;
    }

    async function loadState() {
      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select("state")
        .eq("id", ROW_ID)
        .maybeSingle();

      if (error) {
        console.error("[index] Supabase load error", error);
        return createDefaultState();
      }

      if (!data) {
        const init = createDefaultState();
        const { error: insertErr } = await supabase
          .from(TABLE_NAME)
          .insert({ id: ROW_ID, state: init });
        if (insertErr) console.error("[index] insert error", insertErr);
        return init;
      }

      return data.state || createDefaultState();
    }

    function medalIcon(idx) {
      if (idx === 0) return "ğŸ¥‡";
      if (idx === 1) return "ğŸ¥ˆ";
      if (idx === 2) return "ğŸ¥‰";
      return "#";
    }

    function renderRanks(state) {
      const keys = ["rank_big","rank_small","rank_tour","rank_season"];
      keys.forEach(key => {
        const list = (state[key] || []).slice().sort((a,b) => toNumber(b.score) - toNumber(a.score));
        const top5 = list.slice(0,5);
        const ol = document.querySelector(`ol.ranklist[data-rank="${key}"]`);
        const empty = document.querySelector(`[data-empty-for="${key}"]`);
        if (!ol) return;
        ol.innerHTML = "";
        if (!top5.length) {
          if (empty) empty.style.display = "block";
          return;
        }
        if (empty) empty.style.display = "none";
        top5.forEach((item, idx) => {
          const li = document.createElement("li");
          const name = item.name || "-";
          const score = item.score ?? "";
          li.innerHTML = `
            <span class="rank-medal">${medalIcon(idx)}</span>
            <span class="rank-name">${name}</span>
            <span class="rank-score">${score}</span>
          `;
          if (idx === 3) {
            const chip = document.createElement("span");
            chip.className = "chip-small";
            chip.textContent = "TOP4";
            li.appendChild(chip);
          }
          if (idx === 4) {
            const chip = document.createElement("span");
            chip.className = "chip-small";
            chip.textContent = "TOP5";
            li.appendChild(chip);
          }
          ol.appendChild(li);
        });
      });
    }

    function renderBingo(state) {
      const grid = document.getElementById("bingoGrid");
      const remainSpan = document.getElementById("bingoRemain");
      grid.innerHTML = "";
      const cells = state.bingo || [];
      let remain = 0;
      cells.forEach(cell => {
        const div = document.createElement("div");
        div.className = "bingo-cell" + (cell.used ? " used" : "");
        div.textContent = cell.label || "â€”";
        grid.appendChild(div);
        if (!cell.used) remain++;
      });
      remainSpan.textContent = remain;
    }

    function renderBadges(state) {
      const season = state.season || {
        id: genSeasonId(),
        badges: {
          rank_big: [],
          rank_small: [],
          rank_tour: [],
          rank_season: []
        }
      };
      document.getElementById("seasonLabel").textContent = season.id || "-";
      const badges = season.badges || {};
      ["rank_big","rank_small","rank_tour","rank_season"].forEach(key => {
        const box = document.querySelector(`[data-badge="${key}"]`);
        if (!box) return;
        box.innerHTML = "";
        const arr = (badges[key] || []).filter(Boolean);
        if (!arr.length) {
          const span = document.createElement("span");
          span.className = "badge-pill";
          span.textContent = "ì•„ì§ ì—†ìŒ";
          box.appendChild(span);
          return;
        }
        arr.forEach(name => {
          const span = document.createElement("span");
          span.className = "badge-pill";
          span.textContent = name;
          box.appendChild(span);
        });
      });
    }

    function renderUpdatedAt(state) {
      const el = document.getElementById("updatedAt");
      if (!el) return;
      if (!state.lastUpdated) { el.textContent = "-"; return; }
      try {
        el.textContent = new Date(state.lastUpdated).toLocaleString("ko-KR");
      } catch (e) {
        el.textContent = state.lastUpdated;
      }
    }

    function renderSeasonModal(state) {
      const tbody = document.getElementById("seasonFullBody");
      tbody.innerHTML = "";
      const list = (state.rank_season || []).slice().sort((a,b) => toNumber(b.score) - toNumber(a.score));
      if (!list.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.className = "empty-row";
        td.textContent = "ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      list.forEach((item, idx) => {
        const tr = document.createElement("tr");
        const tdNum = document.createElement("td");
        tdNum.className = "num";
        tdNum.textContent = idx + 1;
        const tdName = document.createElement("td");
        tdName.textContent = item.name || "-";
        const tdScore = document.createElement("td");
        tdScore.className = "score";
        tdScore.textContent = item.score ?? "";
        tr.appendChild(tdNum);
        tr.appendChild(tdName);
        tr.appendChild(tdScore);
        tbody.appendChild(tr);
      });
    }

    function openSeasonModal() {
      const modal = document.getElementById("seasonModal");
      modal.classList.add("show");
    }

    function closeSeasonModal() {
      const modal = document.getElementById("seasonModal");
      modal.classList.remove("show");
    }

    let currentState = null;

    document.addEventListener("DOMContentLoaded", async () => {
      currentState = await loadState();
      renderRanks(currentState);
      renderBingo(currentState);
      renderBadges(currentState);
      renderUpdatedAt(currentState);

      document.getElementById("btnSeasonFull").addEventListener("click", () => {
        renderSeasonModal(currentState);
        openSeasonModal();
      });
      document.getElementById("seasonModalClose").addEventListener("click", closeSeasonModal);
      document.getElementById("seasonModal").addEventListener("click", (e) => {
        if (e.target === e.currentTarget) closeSeasonModal();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeSeasonModal();
      });
    });
  </script>
</body>
</html>
